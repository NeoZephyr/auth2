# 授权码

授权码这种临时的中间值，让资源拥有者参与进来，从而让第三方软件与授权服务之间建立联系，进而让第三方软件代表资源拥有者去访问受保护资源

## 授权流程

1. 资源拥有者使用第三方软件
2. 第三方软件引导授权，跳转到授权服务，附带第三方软件的回调地址。授权服务验证客户端合法性及用户登录状态，生成授权页面
3. 资源拥有者授权
4. 授权服务生成授权码
5. 通过回调地址重定向到第三方软件，并携带授权码
6. 第三方软件获取授权码，发送请求
7. 授权服务生成 access_token，并返回
8. 第三方软件通过 access_token 访问受保护资源


## 第三方软件注册

配置 app_id, app_secret, redirect_url, scope
scope 表示授权范围

受保护资源权限范围
1. 不同权限对应不同的操作
2. 不同权限对应不同的数据
3. 不同用户对应不同的数据


## 颁发授权码

如果在第 4 步，没有授权码，而是直接返回 access_token。那么就不能使用重定向的方式，因为这样会把 access_token 暴露在浏览器上，从而面临访问令牌失窃的风险。在获取 access_token 之前，第三方软件和授权服务之前是通过浏览器这个中间人进行间接通信的

### 准备阶段

1. 验证基本信息：对第三方软件合法性和回调地址合法性校验
2. 验证权限范围：若请求过来的权限范围大于注册范围，提示越权
3. 生成授权页面：资源拥有者可以在授权页面选择缩小权限范围

### 生成授权码

1. 验证权限范围：用资源拥有者授权之后的权限和第三方软件注册的权限做校验
2. 生成授权码：将生成的授权码与 app_id、user 进行关联映射，以便在生成 access_token 时使用。安全起见，给授权码设置一个有效期。同时，将生成的授权码跟已经授权的权限范围绑定存储
3. 重定向到第三方软件：通过重定向方式将授权码告知第三方软件


## 颁发 access_token

1. 验证第三方软件
2. 验证授权码：授权码一旦被使用，须立即作废
3. 生成 access_token：将授权范围与 access_token 绑定，并为 access_token 设置一个过期时间

### 刷新令牌

access_token 是有过期时间的，为了避免资源拥有者重复授权，引入刷新令牌

颁发刷新令牌：第三方软件得到一个访问令牌的同时，也会得到一个刷新令牌
使用刷新令牌：一个刷新令牌被使用之后，授权服务需要将其废弃，并重新生成一个刷新令牌

### JWT

包含信息的令牌称之为结构化令牌，简称 JWT

jwt 构成
1. header: 令牌类型和算法等信息。typ 为 JWT 表示 PAYLOAD 是 JWT 类型，alg 表示签名算法
2. payload: JWT 数据体，代表一组数据。其中，sub 为令牌主体，一般设为资源拥有者的唯一标识；exp 为令牌的过期时间戳；lat 为令牌颁发的时间戳
3. signature: JWT 信息的签名

授权服务颁发 jwt 令牌给第三方软件，第三方软件使用 jwt 令牌请求受保护资源服务。jwt 令牌需要在公网上做传输，在传输过程中，jwt 令牌需要进行 Base64 编码以防止乱码，同时还需要进行签名及加密处理来防止数据信息泄露

jwt 优势
1. 计算代替存储
2. jwt 内部包含重要信息，在整个传输过程中都必须要求密文传输
3. jwt 格式的令牌通过自编码的方式包含了身份验证需要的信息，不再需要服务端的额外存储，每次请求都是无状态的。增强了系统的可用性和伸缩性

jwt 问题：难以在使用过程中修改令牌状态。例如，在使用第三方软件的时候，如果突然修改了密码，就需要将令牌设置为无效。但是，使用 jwt 令牌时，每次颁发的令牌都不在服务端存储，这样就无法改变令牌状态了。这意味着，jwt 令牌在有效期内，可以横行无止

为了解决这个问题，通常有两种做法：
1. 每次生成 jwt 令牌时的密钥粒度缩小到用户级别，当用户取消授权或者修改密码后，让这个密钥一起修改
2. 在没有用户主动取消授权的环境里面，只考虑修改密码的情况下，可以把用户密码作为 jwt 密钥。这样，用户修改密码就相当于修改了密钥

生命周期
jwt 令牌可以把有效期的信息存储在本身的结构体中


## 使用访问令牌

注册信息 -> 引导授权 -> 使用访问令牌

使用访问令牌请求的方式有三种：
1. 表单参数
2. URL 查询参数
3. 授权请求头部字段
4. 使用刷新令牌

保留 expires_in 值保存下来并定时检测
